<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="css/pico.classless.green.css" />
		<title>PVZM</title>
	</head>

	<body>
		<main>
			<h1>PVZM Backend</h1>
			<p><a href="/admin.html">Admin Dashboard</a></p>
			<article>
				<h3>Auth Demo</h3>
				<div id="auth-status">
					<p>Not signed in</p>
				</div>
				<details>
					<summary>Sign Up</summary>
					<form id="signupForm">
						<label for="signup-username">Username</label>
						<input
							type="text"
							name="username"
							id="signup-username"
							placeholder="username"
							required
							pattern="^[a-zA-Z0-9_.]+$"
						/>
						<label for="signup-password">Password</label>
						<input
							type="password"
							name="password"
							id="signup-password"
							placeholder="min 8 characters"
							required
							minlength="8"
						/>
						<label for="signup-turnstile">Verification</label>
						<div id="signup-turnstile-container"></div>
						<button type="submit">Sign Up</button>
					</form>
					<pre id="signupResponse"></pre>
				</details>
				<details>
					<summary>Sign In</summary>
					<form id="signinForm">
						<label for="signin-username">Username</label>
						<input
							type="text"
							name="username"
							id="signin-username"
							placeholder="username"
							required
						/>
						<label for="signin-password">Password</label>
						<input
							type="password"
							name="password"
							id="signin-password"
							placeholder="password"
							required
						/>
						<label for="signin-turnstile">Verification</label>
						<div id="signin-turnstile-container"></div>
						<button type="submit">Sign In</button>
					</form>
					<pre id="signinResponse"></pre>
				</details>
				<button id="signoutBtn" style="display: none">Sign Out</button>
			</article>
			<article>
				<code>GET /api/config</code>
				<h3>Server Settings</h3>
				<pre id="settings">{}</pre>
			</article>
			<article>
				<code>POST /api/levels</code>
				<h3>Upload Level</h3>
				<form id="uploadForm">
					<!-- author -->
					<label for="author">Author</label>
					<input type="text" name="author" placeholder="Me" />
					<!-- file upload -->
					<label for="levelFile">Level File</label>
					<input type="file" name="levelFile" accept=".izl,.izl2,.izl3" />
					<!-- turnstileResponse -->
					<label for="turnstileResponse">Turnstile Response</label>
					<div id="turnstile-container"></div>
					<button type="submit">Upload</button>
				</form>
				<footer>
					<h4>Response</h4>
					<pre id="response">{}</pre>
				</footer>
			</article>
			<article>
				<code>GET /api/levels</code>
				<h3>Levels</h3>
				<div id="levelsList">
					<!--  will be populated by JavaScript -->
				</div>
				<div id="levelsPagination"></div>

				<!-- level template -->
				<template id="level-template">
					<article class="level-item">
						<h4 class="level-name"></h4>
						ü™™ ID: <code class="level-id"></code>
						<br />
						üë§ By <span class="level-author"></span>
						<br />
						üìÖ Created at: <code class="level-created-at"></code>
						<br />
						‚òÄÔ∏è Sun: <code class="level-sun"></code>
						<br />
						üåä Is Water:
						<input type="checkbox" class="level-is-water" disabled />
						<br />
						‚≠ê Favorites: <span class="level-favorites"></span>
						<br />
						üéÆ Plays: <span class="level-plays"></span>
						<br />
						üì¶ Version: <code class="level-version"></code>
						<br />
						<div class="level-actions">
							<button class="details-btn">Details</button>
							<button class="download-btn">Download</button>
							<button class="favorite-btn">‚≠ê</button>
						</div>
					</article>
				</template>

				<!-- pagination template -->
				<template id="pagination-template">
					<nav class="pagination">
						<button class="prev-page">Previous</button>
						<span class="page-info">Page 1 of 1</span>
						<button class="next-page">Next</button>
					</nav>
				</template>
			</article>
			<article id="levelDetailsSection">
				<code>GET /api/levels/:id</code>
				<h3>Level Details</h3>
				<form id="getLevelForm">
					<label for="id">ID</label>
					<input type="text" name="id" placeholder="123" />
					<button type="submit">Get Level</button>
				</form>
				<footer>
					<h4>Response</h4>
					<pre id="levelDetails">{}</pre>
				</footer>
			</article>
			<article>
				<code>GET /api/levels/:id/download</code>
				<h3>Download Level</h3>
				<form id="downloadForm">
					<label for="id">ID</label>
					<input type="text" name="id" placeholder="123" />
					<button type="submit">Download Level</button>
				</form>
				<!-- response is a file, but keep response incase of error -->
				<footer>
					<h4>Response</h4>
					<pre id="downloadResponse">{}</pre>
				</footer>
			</article>
			<article>
				<code>POST /api/levels/:id/favorite</code>
				<h3>Favorite Level</h3>
				<form id="favoriteForm">
					<label for="id">ID</label>
					<input type="text" name="id" placeholder="123" />
					<button type="submit">Toggle Favorite</button>
				</form>
				<footer>
					<h4>Response</h4>
					<pre id="favoriteResponse">{}</pre>
				</footer>
			</article>
		</main>
		<script type="module">
			import { createAuthClient } from "https://esm.sh/better-auth@1.4.18/client";
			import { usernameClient } from "https://esm.sh/better-auth@1.4.18/client/plugins";

			const authClient = createAuthClient({
				plugins: [usernameClient()],
			});

			const EMAIL_DOMAIN = "noemail.local";

			async function refreshAuthStatus() {
				const statusEl = document.getElementById("auth-status");
				const signoutBtn = document.getElementById("signoutBtn");
				const { data } = await authClient.getSession();
				if (data?.user) {
					statusEl.innerHTML = `<p>Signed in as <strong>${data.user.name || data.user.username || "?"}</strong> (role: ${data.user.role || "user"})</p>`;
					signoutBtn.style.display = "";
				} else {
					statusEl.innerHTML = "<p>Not signed in</p>";
					signoutBtn.style.display = "none";
				}
			}

			document.getElementById("signupForm").addEventListener("submit", async (e) => {
				e.preventDefault();

				if (config.turnstileEnabled && !signupTurnstileToken) {
					document.getElementById("signupResponse").textContent = JSON.stringify(
						{ error: "Please complete the CAPTCHA verification" },
						null,
						2,
					);
					return;
				}

				const username = document.getElementById("signup-username").value;
				const password = document.getElementById("signup-password").value;
				const email = `${username}@${EMAIL_DOMAIN}`;
				const { data, error } = await authClient.signUp.email({
					email,
					password,
					name: username,
					username,
					fetchOptions: signupTurnstileToken
						? {
								headers: {
									"x-captcha-response": signupTurnstileToken,
								},
							}
						: undefined,
				});
				document.getElementById("signupResponse").textContent = JSON.stringify(
					error || data,
					null,
					2,
				);
				if (!error) {
					refreshAuthStatus();
					if (config.turnstileEnabled && window.turnstile && signupTurnstileWidgetId) {
						window.turnstile.reset(signupTurnstileWidgetId);
						signupTurnstileToken = null;
					}
				}
			});

			document.getElementById("signinForm").addEventListener("submit", async (e) => {
				e.preventDefault();

				if (config.turnstileEnabled && !signinTurnstileToken) {
					document.getElementById("signinResponse").textContent = JSON.stringify(
						{ error: "Please complete the CAPTCHA verification" },
						null,
						2,
					);
					return;
				}

				const username = document.getElementById("signin-username").value;
				const password = document.getElementById("signin-password").value;
				const { data, error } = await authClient.signIn.username({
					username,
					password,
					fetchOptions: signinTurnstileToken
						? {
								headers: {
									"x-captcha-response": signinTurnstileToken,
								},
							}
						: undefined,
				});
				document.getElementById("signinResponse").textContent = JSON.stringify(
					error || data,
					null,
					2,
				);
				if (!error) {
					refreshAuthStatus();
					if (config.turnstileEnabled && window.turnstile && signinTurnstileWidgetId) {
						window.turnstile.reset(signinTurnstileWidgetId);
						signinTurnstileToken = null;
					}
				}
			});

			document.getElementById("signoutBtn").addEventListener("click", async () => {
				await authClient.signOut();
				refreshAuthStatus();
			});

			refreshAuthStatus();
		</script>
		<script>
			let turnstileToken = null;
			let signupTurnstileToken = null;
			let signinTurnstileToken = null;
			let config = {};
			let turnstileWidgetId = null;
			let signupTurnstileWidgetId = null;
			let signinTurnstileWidgetId = null;

			function formatDate(timestamp) {
				return new Date(timestamp * 1000).toLocaleString();
			}

			async function fetchConfig() {
				try {
					const response = await fetch("/api/config");
					config = await response.json();
					document.getElementById("settings").textContent = JSON.stringify(
						config,
						null,
						2,
					);

					if (config.turnstileEnabled && config.turnstileSiteKey) {
						loadTurnstileWidget(config.turnstileSiteKey);
					} else {
						const turnstileContainer = document.getElementById("turnstile-container");
						if (turnstileContainer) {
							turnstileContainer.closest("label").style.display = "none";
						}
						const signupContainer = document.getElementById("signup-turnstile-container");
						if (signupContainer) {
							signupContainer.closest("label").style.display = "none";
						}
						const signinContainer = document.getElementById("signin-turnstile-container");
						if (signinContainer) {
							signinContainer.closest("label").style.display = "none";
						}
					}
				} catch (error) {
					console.error("Error fetching config:", error);
				}
			}

			function loadTurnstileWidget(siteKey) {
				if (!window.turnstile) {
					const script = document.createElement("script");
					script.src =
						"https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit";
					script.async = true;
					script.defer = true;

					script.onload = () => {
						renderTurnstileWidget(siteKey);
					};

					document.head.appendChild(script);
				} else {
					renderTurnstileWidget(siteKey);
				}
			}

			function renderTurnstileWidget(siteKey) {
				const container = document.getElementById("turnstile-container");
				container.innerHTML = "";

				if (window.turnstile) {
					turnstileWidgetId = window.turnstile.render("#turnstile-container", {
						sitekey: siteKey,
						callback: function (token) {
							turnstileToken = token;
						},
					});

					const signupContainer = document.getElementById("signup-turnstile-container");
					if (signupContainer) {
						signupContainer.innerHTML = "";
						signupTurnstileWidgetId = window.turnstile.render(
							"#signup-turnstile-container",
							{
								sitekey: siteKey,
								callback: function (token) {
									signupTurnstileToken = token;
								},
							},
						);
					}

					const signinContainer = document.getElementById("signin-turnstile-container");
					if (signinContainer) {
						signinContainer.innerHTML = "";
						signinTurnstileWidgetId = window.turnstile.render(
							"#signin-turnstile-container",
							{
								sitekey: siteKey,
								callback: function (token) {
									signinTurnstileToken = token;
								},
							},
						);
					}
				}
			}

			async function loadLevels(page = 1, limit = 10) {
				try {
					const response = await fetch(`/api/levels?page=${page}&limit=${limit}`);
					const data = await response.json();

					if (data.levels && Array.isArray(data.levels)) {
						const levelsListElement = document.getElementById("levelsList");
						levelsListElement.innerHTML = "";
						const template = document.getElementById("level-template");

						if (data.levels.length === 0) {
							levelsListElement.innerHTML = "<p>No levels found.</p>";
							return;
						}

						data.levels.forEach((level) => {
							const levelElement = template.content
								.cloneNode(true)
								.querySelector(".level-item");

							levelElement.querySelector(".level-name").textContent = level.name;
							levelElement.querySelector(".level-id").textContent = level.id;
							levelElement.querySelector(".level-author").textContent = level.author;
							levelElement.querySelector(".level-created-at").textContent = formatDate(
								level.created_at,
							);
							levelElement.querySelector(".level-sun").textContent = level.sun;
							levelElement.querySelector(".level-is-water").checked = level.is_water;
							levelElement.querySelector(".level-favorites").textContent = level.favorites;
							levelElement.querySelector(".level-plays").textContent = level.plays;
							levelElement.querySelector(".level-version").textContent = level.version;

							const buttons = levelElement.querySelectorAll("button");
							buttons.forEach((btn) => {
								btn.setAttribute("data-id", level.id);
							});

							levelsListElement.appendChild(levelElement);
						});

						setupLevelButtonListeners();

						createPaginationControls(data.pagination);
					}
				} catch (error) {
					console.error("Error loading levels:", error);
					document.getElementById("levelsList").innerHTML =
						"<p>Error loading levels.</p>";
				}
			}

			function createPaginationControls(pagination) {
				const paginationElement = document.getElementById("levelsPagination");
				paginationElement.innerHTML = "";

				if (!pagination || pagination.pages <= 1) {
					return;
				}

				const totalPages = pagination.pages;
				const currentPage = pagination.page;

				const template = document.getElementById("pagination-template");
				const nav = template.content.cloneNode(true).querySelector(".pagination");

				const prevBtn = nav.querySelector(".prev-page");
				prevBtn.disabled = currentPage <= 1;
				prevBtn.onclick = () => loadLevels(currentPage - 1, pagination.limit);

				const pageInfo = nav.querySelector(".page-info");
				pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

				const nextBtn = nav.querySelector(".next-page");
				nextBtn.disabled = currentPage >= totalPages;
				nextBtn.onclick = () => loadLevels(currentPage + 1, pagination.limit);

				paginationElement.appendChild(nav);
			}

			function setupLevelButtonListeners() {
				document.querySelectorAll(".details-btn").forEach((btn) => {
					btn.addEventListener("click", async () => {
						document.getElementById("levelDetailsSection").scrollIntoView({
							behavior: "smooth",
						});
						const levelId = btn.getAttribute("data-id");
						await getLevelDetails(levelId);
					});
				});

				document.querySelectorAll(".download-btn").forEach((btn) => {
					btn.addEventListener("click", async () => {
						const levelId = btn.getAttribute("data-id");
						await downloadLevel(levelId);
					});
				});

				document.querySelectorAll(".favorite-btn").forEach((btn) => {
					btn.addEventListener("click", async () => {
						const levelId = btn.getAttribute("data-id");
						await toggleFavorite(levelId);
					});
				});
			}

			async function getLevelDetails(id) {
				try {
					const response = await fetch(`/api/levels/${id}`);
					const data = await response.json();
					document.getElementById("levelDetails").textContent = JSON.stringify(
						data,
						null,
						2,
					);

					const getLevelForm = document.getElementById("getLevelForm");
					if (getLevelForm) {
						getLevelForm.querySelector('input[name="id"]').value = id;
					}
				} catch (error) {
					console.error("Error getting level details:", error);
					document.getElementById("levelDetails").textContent = JSON.stringify(
						{ error: error.message },
						null,
						2,
					);
				}
			}

			async function downloadLevel(id) {
				try {
					window.location.href = `/api/levels/${id}/download`;
					document.getElementById("downloadResponse").textContent =
						"Download initiated...";

					const downloadForm = document.getElementById("downloadForm");
					if (downloadForm) {
						downloadForm.querySelector('input[name="id"]').value = id;
					}
				} catch (error) {
					console.error("Error downloading level:", error);
					document.getElementById("downloadResponse").textContent = JSON.stringify(
						{ error: error.message },
						null,
						2,
					);
				}
			}

			async function toggleFavorite(id) {
				try {
					// no captcha verification needed for favorites
					const response = await fetch(`/api/levels/${id}/favorite`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({}),
					});

					const data = await response.json();
					document.getElementById("favoriteResponse").textContent = JSON.stringify(
						data,
						null,
						2,
					);

					if (data.success) {
						loadLevels();
					}

					const favoriteForm = document.getElementById("favoriteForm");
					if (favoriteForm) {
						favoriteForm.querySelector('input[name="id"]').value = id;
					}
				} catch (error) {
					console.error("Error favoriting level:", error);
					document.getElementById("favoriteResponse").textContent = JSON.stringify(
						{ error: error.message },
						null,
						2,
					);
				}
			}

			async function uploadLevel(formData) {
				try {
					const fileInput = document.querySelector('input[name="levelFile"]');
					if (!fileInput.files || fileInput.files.length === 0) {
						throw new Error("Please select a level file");
					}

					if (config.turnstileEnabled && !turnstileToken) {
						throw new Error("Please complete the CAPTCHA verification");
					}

					const file = fileInput.files[0];
					const reader = new FileReader();

					reader.onload = async function (e) {
						const fileData = e.target.result;

						const params = new URLSearchParams({
							author: formData.get("author"),
						});

						if (turnstileToken) {
							params.append("turnstileResponse", turnstileToken);
						}

						const response = await fetch(`/api/levels?${params}`, {
							method: "POST",
							headers: {
								"Content-Type": "application/octet-stream",
							},
							body: new Uint8Array(fileData),
						});

						const data = await response.json();
						document.getElementById("response").textContent = JSON.stringify(data, null, 2);

						if (response.ok) {
							loadLevels();

							document.getElementById("uploadForm").reset();
							if (config.turnstileEnabled && window.turnstile && turnstileWidgetId) {
								window.turnstile.reset(turnstileWidgetId);
								turnstileToken = null;
							}
						}
					};

					reader.readAsArrayBuffer(file);
				} catch (error) {
					console.error("Error uploading level:", error);
					document.getElementById("response").textContent = JSON.stringify(
						{ error: error.message },
						null,
						2,
					);
				}
			}

			document.addEventListener("DOMContentLoaded", () => {
				fetchConfig();
				loadLevels();

				const uploadForm = document.getElementById("uploadForm");
				if (uploadForm) {
					uploadForm.addEventListener("submit", (e) => {
						e.preventDefault();
						const formData = new FormData(uploadForm);
						uploadLevel(formData);
					});
				}

				const getLevelForm = document.getElementById("getLevelForm");
				if (getLevelForm) {
					getLevelForm.addEventListener("submit", (e) => {
						e.preventDefault();
						const levelId = getLevelForm.querySelector('input[name="id"]').value;
						getLevelDetails(levelId);
					});
				}

				const downloadForm = document.getElementById("downloadForm");
				if (downloadForm) {
					downloadForm.addEventListener("submit", (e) => {
						e.preventDefault();
						const levelId = downloadForm.querySelector('input[name="id"]').value;
						downloadLevel(levelId);
					});
				}

				const favoriteForm = document.getElementById("favoriteForm");
				if (favoriteForm) {
					favoriteForm.addEventListener("submit", (e) => {
						e.preventDefault();
						const levelId = favoriteForm.querySelector('input[name="id"]').value;
						toggleFavorite(levelId);
					});
				}
			});
		</script>
	</body>
</html>
